<!DOCTYPE html>

<! â€“â€“ ///// HTML ///// â€“â€“>
<html lang="en" dir="ltr">

    <! â€“â€“ ///// TITLE ///// â€“â€“> 
    <head>
        <meta charset="utf-8">
        <title>MQTT Robot ðŸŽ®</title>
    </head>

    <! â€“â€“ ///// BODY ///// â€“â€“> 
    <body>

        <! â€“â€“ ///// PAGE CONTENT ///// â€“â€“>
        <h1> ðŸŽ® Conduce el Robot IoT ðŸŽ®</h1>
        <div id = "instructions">Instrucciones:</div> 
        <div id = "instructions">Usa las siguientes teclas para moverte: 8â¬† | 2â¬‡ | 4â¬… | 6âž¡</div>
        <div id = "instructions">ðŸ›‘Presina UNA SOLA VEZ o voy a acelerar hasta morirðŸ›‘</div>
        <div id = "instructions">Usa los botones para conocer la distancia que hay en esa direcciÃ³n</div>  

        <div id = "Divisor">================================================</div><br><br>

        <div id = "set_angulo">Elige la direcciÃ³n del sensor:</div>
        <button onclick = "command(0)" type = "button">Izquierda</button> 
        <button onclick = "command(1)" type = "button">45Â° Izquierda</button> 
        <button onclick = "command(2)" type = "button">Frente</button> 
        <button onclick = "command(3)" type = "button">45Â° Drecha</button> 
        <button onclick = "command(4)" type = "button">Derecha</button> <br><br>
        <div id = "distance">La distancia es: </div><br><br>

        <div id = "Divisor">================================================</div><br>

        <div id = "status">ðŸ”´ Desconectado</div> 
        <div id = "display">ConexiÃ³n con ESP32</div> 
        <div id = "display">Hecho por: @emma.sirangua</div> 


        <! â€“â€“ ///// LIBRARIES ///// â€“â€“>
        <script src = "https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
        <script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>


        <! â€“â€“ ///// SCRIPT TO SEND MESSAGES ///// â€“â€“>
        <script type = "text/javascript">

            ////////////////////  To Move ////////////////////
            document.addEventListener("keypress", function onEvent(event) {
                if(event.key == 8){
                    client.publish("Inputs","straight")
                }
                if(event.key == 2){
                    client.publish("Inputs","back")
                }
                if(event.key == 4){
                    client.publish("Inputs","left")
                }
                if(event.key == 6){
                    client.publish("Inputs","right")
                }
            });

            //////////////////// Key Up to Stop ////////////////////
            document.addEventListener("keyup", function onEvent(event) {
                console.log("Key Up" + event.key)
                client.publish("Inputs","stop")
            });

            ////////////////////  Buttons ////////////////////
            function command(value){
                client.publish ('servo', value.toString(), (error) =>{
                    console.log (error || 'Envio correcto')
                });
            }
        </script>


        <! â€“â€“ ///// SCRIPT TO MQTT ///// â€“â€“>
        <script type="text/javascript">

            ////////////////////  Conection details ////////////////////
            const options = {
                connectTimeout: 4000,
                clientId: 'Control_IoT',
                keepalive: 60,
                clean: true,    
                username: 'Web_control',
                password: '9c054m7tc98',
            }


            ////////////////////  MQTT Conection ////////////////////
            const WebSocket_URL = 'ws://IP:PORT/mqtt'                           // Add Your Own Information
            const client = mqtt.connect (WebSocket_URL, options);
            $("#status").html("ðŸŸ¡ Intentando conexiÃ³n con EMQX <br>");


            ////////////////////  MQTT Conected ////////////////////
            client.on ('connect', () => {
            console.log ('MQTT conectado por WebSocket')
            $("#status").html("ðŸŸ¢ Conectado via MQTT")

                
            ////////////////////  Subscritions ////////////////////
            client.subscribe ('Outputs', {qos: 0 }, (error) => {
                if (!error){
                    console.log ('SuscripciÃ³n realizada')
                } else {
                    console.log ('Error en la suscripciÃ³n')
                }
            })
            client.subscribe ('Board', {qos: 0 }, (error) => {
                if (!error){
                    console.log ('SuscripciÃ³n realizada')
                } else {
                    console.log ('Error en la suscripciÃ³n')
                }
                })
            })


            ////////////////////  Recieve Messages ////////////////////
            //Conected to board
            client.on('message', (topic, message) => {
                if (topic == 'Board'){
                    $("#display").html(message.toString() + "<br>");
                } 
            })

            // Distance
            client.on('message', (topic, message) => {
                if (topic == 'Outputs'){
                    $("#distance").html("La distancia es: "+ message.toString() + " centimetros <br>");
                } 
            })


            ////////////////////  Reconnect ////////////////////
            client.on('reconnect', (error) => {
                console.log('reconnecting:', error);
                $("#status").html("ðŸ”µ Reconectando... <br>");
            })


            ////////////////////  Error ////////////////////
            client.on('error', (error) => {
                console.log('Connect Error:', error);
                $("#status").html("ðŸ”´ Error en la conexiÃ³n <br>");
            })

        </script>
    </body>
</html>